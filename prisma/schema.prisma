// Truong Viet Ngu - Vietnamese Language School Database Schema
// This schema supports admin management of announcements, classes, materials, and site settings

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// AUTHENTICATION & ADMIN MANAGEMENT
// ============================================

model Admin {
  id          String    @id @default(cuid())
  email       String    @unique
  password    String    // bcrypt hashed
  name        String
  role        Role      @default(ADMIN)
  isActive    Boolean   @default(true)
  lastLoginAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([email])
  @@map("admins")
}

enum Role {
  ADMIN
  SUPER_ADMIN
}

// ============================================
// ANNOUNCEMENTS
// ============================================

model Announcement {
  id          String            @id @default(cuid())
  title       String            // Vietnamese title
  description String            @db.Text // Rich text content
  category    AnnouncementCategory
  startDate   DateTime
  endDate     DateTime?         // Optional end date
  priority    Int               @default(0) // Higher number = higher priority
  isActive    Boolean           @default(true)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  // Indexes for common queries
  @@index([isActive, priority(sort: Desc), startDate(sort: Desc)])
  @@index([category])
  @@index([startDate])
  @@map("announcements")
}

enum AnnouncementCategory {
  CHOIR       // Ca đoàn TNTT
  BIBLE       // Chương Trình Đọc Sách Thánh
  EVENT       // General events
  GENERAL     // General announcements
  HOLIDAY     // Holidays and closures
}

// ============================================
// TEACHERS
// ============================================

model Teacher {
  id          String    @id @default(cuid())
  firstName   String
  lastName    String
  email       String    @unique
  password    String?   // bcrypt hashed (optional for legacy teachers)
  phone       String?
  photoUrl    String?
  bio         String?   @db.Text
  isActive    Boolean   @default(true)
  isApproved  Boolean   @default(false) // Requires admin approval
  lastLoginAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  classes     Class[]  // A teacher can teach multiple classes

  @@index([email])
  @@index([isActive])
  @@map("teachers")
}

// ============================================
// CLASSES
// ============================================

model Class {
  id              String   @id @default(cuid())
  name            String   // e.g., "Lớp MG-A", "Lớp 1"
  gradeLevel      GradeLevel
  classroomImage  String?  // Path to classroom image
  classPhotoImage String?  // Path to class photo
  schedule        String?  // e.g., "Saturday 9:00 AM - 11:00 AM"
  roomNumber      String?
  description     String?  @db.Text
  isActive        Boolean  @default(true)
  displayOrder    Int      @default(0) // For custom ordering
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  teacherId       String?  // Foreign key to Teacher
  teacher         Teacher? @relation(fields: [teacherId], references: [id], onDelete: SetNull)
  enrollments     Enrollment[] // Students enrolled in this class
  attendance      Attendance[]
  grades          Grade[]
  reportCards     ReportCard[]

  // Indexes for queries
  @@index([isActive, gradeLevel, displayOrder])
  @@index([gradeLevel])
  @@index([teacherId])
  @@map("classes")
}

// ============================================
// STUDENTS
// ============================================

model Student {
  id              String   @id @default(cuid())
  firstName       String
  lastName        String
  dateOfBirth     DateTime?
  gradeLevel      GradeLevel?
  photoUrl        String?
  parentId        String?  // Link to parent account
  parentName      String?
  parentEmail     String?
  parentPhone     String?
  address         String?  @db.Text
  emergencyContact String?
  notes           String?  @db.Text
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  parent          Parent?      @relation(fields: [parentId], references: [id], onDelete: SetNull)
  enrollments     Enrollment[] // Classes this student is enrolled in
  attendance      Attendance[]
  grades          Grade[]
  reportCards     ReportCard[]

  @@index([isActive])
  @@index([lastName, firstName])
  @@index([gradeLevel])
  @@index([parentId])
  @@map("students")
}

// ============================================
// ENROLLMENTS (Students in Classes)
// ============================================

model Enrollment {
  id              String   @id @default(cuid())
  studentId       String
  classId         String
  enrollmentDate  DateTime @default(now())
  status          EnrollmentStatus @default(ACTIVE)
  notes           String?  @db.Text
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  student         Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  class           Class    @relation(fields: [classId], references: [id], onDelete: Cascade)

  // Ensure a student can only be enrolled once per class
  @@unique([studentId, classId])
  @@index([studentId])
  @@index([classId])
  @@index([status])
  @@map("enrollments")
}

enum EnrollmentStatus {
  ACTIVE
  INACTIVE
  COMPLETED
  DROPPED
}

enum GradeLevel {
  MAU_GIAO_A    // Mẫu giáo A
  MAU_GIAO_B    // Mẫu giáo B
  MAU_GIAO_C    // Mẫu giáo C
  LOP_1         // Lớp 1 (7-9 tuổi)
  LOP_2         // Lớp 2 (10-12 tuổi)
  LOP_3         // Lớp 3 (13-15 tuổi)
  LOP_4         // Lớp 4 (16-18 tuổi)
  LOP_5         // Lớp 5
  LOP_6         // Lớp 6
  LOP_7         // Lớp 7
  AU_NHI        // TNTT: Ấu Nhi (7-9 tuổi)
  THIEU_NHI     // TNTT: Thiếu Nhi (10-12 tuổi)
  NGHIA_SI      // TNTT: Nghĩa Sĩ (13-15 tuổi)
  HIEP_SI       // TNTT: Hiệp Sĩ (16-18 tuổi)
}

// ============================================
// LEARNING MATERIALS
// ============================================

model LearningMaterial {
  id            String      @id @default(cuid())
  title         String      // e.g., "Tomathien.org Lessons"
  gradeLevel    GradeLevel
  lessonNumbers String?     // e.g., "1 + 21 17" or "1 tới 16"
  externalLink  String?     // URL to external resource
  fileUrl       String?     // Path to uploaded PDF/document
  description   String?     @db.Text
  isActive      Boolean     @default(true)
  displayOrder  Int         @default(0)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@index([isActive, gradeLevel, displayOrder])
  @@index([gradeLevel])
  @@map("learning_materials")
}

// ============================================
// SITE SETTINGS
// ============================================

model SiteSetting {
  id                String   @id @default("site_settings") // Singleton pattern
  organizationName  String   @default("Trường Việt Ngữ")
  subtitle          String   @default("Thiếu Nhi Thánh Thể")
  location          String   @default("Honolulu, HI")
  leftLogoUrl       String?  // Path to Công đoàn logo
  rightLogoUrl      String?  // Path to TNTT logo
  heroBackground    String?  // Path to hero background image
  heroBackgroundColor String @default("#1e3a5f") // Default navy blue
  welcomeMessage    String?  @db.Text
  contactEmail      String?
  contactPhone      String?
  address           String?
  facebookUrl       String?
  youtubeUrl        String?
  updatedAt         DateTime @updatedAt

  @@map("site_settings")
}

// ============================================
// IMAGE GALLERY (Optional - for future expansion)
// ============================================

model Image {
  id          String     @id @default(cuid())
  filename    String
  filepath    String
  altText     String?
  category    ImageCategory
  uploadedBy  String?    // Admin email or name
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())

  @@index([category, isActive])
  @@map("images")
}

enum ImageCategory {
  LOGO
  CLASSROOM
  CLASS_PHOTO
  HERO_BACKGROUND
  ANNOUNCEMENT
  GALLERY
  SLIDESHOW
  GENERAL
}

// ============================================
// PHOTO GALLERY ALBUMS
// ============================================

model GalleryAlbum {
  id          String   @id @default(cuid())
  title       String
  description String?  @db.Text
  coverImage  String?
  eventDate   DateTime?
  isActive    Boolean  @default(true)
  displayOrder Int     @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  photos      GalleryPhoto[]

  @@index([isActive, displayOrder])
  @@map("gallery_albums")
}

model GalleryPhoto {
  id          String   @id @default(cuid())
  albumId     String
  imageUrl    String
  caption     String?
  displayOrder Int     @default(0)
  createdAt   DateTime @default(now())

  // Relations
  album       GalleryAlbum @relation(fields: [albumId], references: [id], onDelete: Cascade)

  @@index([albumId, displayOrder])
  @@map("gallery_photos")
}

// ============================================
// HOMEPAGE SLIDESHOW
// ============================================

model SlideshowSlide {
  id           String   @id @default(cuid())
  imageUrl     String
  title        String?
  subtitle     String?
  linkUrl      String?
  linkText     String?
  displayOrder Int      @default(0)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([isActive, displayOrder])
  @@map("slideshow_slides")
}

// ============================================
// CALENDAR EVENTS
// ============================================

model CalendarEvent {
  id            String        @id @default(cuid())
  title         String
  description   String?       @db.Text
  eventType     EventType
  startDate     DateTime
  endDate       DateTime?
  startTime     String?       // e.g., "9:00 AM"
  endTime       String?       // e.g., "12:00 PM"
  location      String?
  isRecurring   Boolean       @default(false)
  isActive      Boolean       @default(true)
  allowRSVP     Boolean       @default(false) // Enable RSVP for this event
  maxAttendees  Int?          // Optional capacity limit
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relations
  rsvps         EventRSVP[]

  @@index([isActive, startDate])
  @@index([eventType])
  @@map("calendar_events")
}

enum EventType {
  CLASS           // Regular class
  TNTT            // TNTT activities
  HOLIDAY         // School holidays
  SPECIAL_EVENT   // Special events
  MASS            // Mass/liturgical events
  MEETING         // Parent/teacher meetings
}

// ============================================
// ABSENCE REPORTS
// ============================================

model AbsenceReport {
  id            String   @id @default(cuid())
  studentName   String
  parentName    String
  parentEmail   String
  parentPhone   String?
  absenceDate   DateTime
  reason        String   @db.Text
  additionalNotes String? @db.Text
  status        AbsenceStatus @default(PENDING)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([absenceDate])
  @@index([status])
  @@map("absence_reports")
}

enum AbsenceStatus {
  PENDING
  APPROVED
  NOTED
}

// ============================================
// NEWSLETTER SUBSCRIBERS
// ============================================

model NewsletterSubscriber {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  @@index([email])
  @@map("newsletter_subscribers")
}

// ============================================
// PARENT ACCOUNTS
// ============================================

model Parent {
  id           String   @id @default(cuid())
  email        String   @unique
  password     String   // bcrypt hashed
  firstName    String
  lastName     String
  phone        String?
  isActive     Boolean  @default(true)
  isVerified   Boolean  @default(false)
  lastLoginAt  DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  students     Student[]

  @@index([email])
  @@map("parents")
}

// ============================================
// AUDIT LOG (Optional - for tracking changes)
// ============================================

model AuditLog {
  id        String   @id @default(cuid())
  adminId   String?  // Who made the change
  action    String   // "CREATE", "UPDATE", "DELETE"
  entity    String   // "Announcement", "Class", etc.
  entityId  String   // ID of the affected record
  changes   Json?    // Old and new values
  createdAt DateTime @default(now())

  @@index([adminId])
  @@index([entity, entityId])
  @@index([createdAt(sort: Desc)])
  @@map("audit_logs")
}

// ============================================
// STUDENT REGISTRATION APPLICATIONS
// ============================================

model RegistrationApplication {
  id                String   @id @default(cuid())
  // Student Info
  studentFirstName  String
  studentLastName   String
  studentDOB        DateTime
  preferredGrade    GradeLevel?
  // Parent Info
  parentFirstName   String
  parentLastName    String
  parentEmail       String
  parentPhone       String
  parentRelation    String   // Mother, Father, Guardian
  // Additional Parent (optional)
  parent2FirstName  String?
  parent2LastName   String?
  parent2Email      String?
  parent2Phone      String?
  parent2Relation   String?
  // Address
  address           String
  city              String
  state             String   @default("HI")
  zipCode           String
  // Emergency Contact
  emergencyName     String
  emergencyPhone    String
  emergencyRelation String
  // Additional Info
  previousSchool    String?
  medicalNotes      String?  @db.Text
  allergies         String?
  specialNeeds      String?  @db.Text
  howHeard          String?  // How did you hear about us?
  additionalNotes   String?  @db.Text
  // Status
  status            RegistrationStatus @default(PENDING)
  reviewedBy        String?
  reviewedAt        DateTime?
  reviewNotes       String?  @db.Text
  // Timestamps
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([status])
  @@index([parentEmail])
  @@index([createdAt(sort: Desc)])
  @@map("registration_applications")
}

enum RegistrationStatus {
  PENDING
  UNDER_REVIEW
  APPROVED
  WAITLISTED
  REJECTED
}

// ============================================
// ATTENDANCE TRACKING
// ============================================

model Attendance {
  id           String   @id @default(cuid())
  studentId    String
  classId      String
  date         DateTime
  status       AttendanceStatus
  notes        String?
  markedBy     String?  // Teacher ID who marked
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  student      Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  class        Class    @relation(fields: [classId], references: [id], onDelete: Cascade)

  @@unique([studentId, classId, date])
  @@index([classId, date])
  @@index([studentId])
  @@index([date])
  @@map("attendance")
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  EXCUSED
}

// ============================================
// GRADES & REPORT CARDS
// ============================================

model Grade {
  id           String   @id @default(cuid())
  studentId    String
  classId      String
  category     GradeCategory
  name         String   // e.g., "Bài kiểm tra 1", "Homework Week 1"
  score        Float?   // Numeric score
  letterGrade  String?  // A, B, C, D, F
  maxScore     Float    @default(100)
  weight       Float    @default(1) // For weighted grades
  comments     String?  @db.Text
  gradedBy     String?  // Teacher ID
  gradedAt     DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  student      Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  class        Class    @relation(fields: [classId], references: [id], onDelete: Cascade)

  @@index([studentId, classId])
  @@index([classId])
  @@map("grades")
}

enum GradeCategory {
  QUIZ
  TEST
  HOMEWORK
  PARTICIPATION
  PROJECT
  FINAL_EXAM
  OTHER
}

model ReportCard {
  id              String   @id @default(cuid())
  studentId       String
  classId         String
  semester        String   // e.g., "Fall 2024", "Spring 2025"
  academicYear    String   // e.g., "2024-2025"
  overallGrade    String?  // A, B, C, etc.
  readingGrade    String?
  writingGrade    String?
  speakingGrade   String?
  behaviorGrade   String?  // Excellent, Good, Needs Improvement
  attendance      Int?     // Number of classes attended
  totalClasses    Int?     // Total number of classes
  teacherComments String?  @db.Text
  isPublished     Boolean  @default(false)
  publishedAt     DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  student         Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  class           Class    @relation(fields: [classId], references: [id], onDelete: Cascade)

  @@unique([studentId, classId, semester, academicYear])
  @@index([studentId])
  @@index([classId])
  @@index([semester, academicYear])
  @@map("report_cards")
}

// ============================================
// EVENT RSVP
// ============================================

model EventRSVP {
  id            String   @id @default(cuid())
  eventId       String
  name          String
  email         String
  phone         String?
  numberOfGuests Int     @default(1)
  dietaryNeeds  String?
  notes         String?
  status        RSVPStatus @default(CONFIRMED)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  event         CalendarEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([eventId, email])
  @@index([eventId])
  @@map("event_rsvps")
}

enum RSVPStatus {
  CONFIRMED
  CANCELLED
  WAITLISTED
}

// ============================================
// VOLUNTEER OPPORTUNITIES & SIGNUPS
// ============================================

model VolunteerOpportunity {
  id              String   @id @default(cuid())
  title           String
  description     String   @db.Text
  date            DateTime?
  startTime       String?
  endTime         String?
  location        String?
  spotsAvailable  Int?
  requirements    String?  @db.Text
  contactName     String?
  contactEmail    String?
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  signups         VolunteerSignup[]

  @@index([isActive, date])
  @@map("volunteer_opportunities")
}

model VolunteerSignup {
  id              String   @id @default(cuid())
  opportunityId   String
  firstName       String
  lastName        String
  email           String
  phone           String?
  notes           String?
  status          VolunteerStatus @default(PENDING)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  opportunity     VolunteerOpportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)

  @@unique([opportunityId, email])
  @@index([opportunityId])
  @@index([email])
  @@map("volunteer_signups")
}

enum VolunteerStatus {
  PENDING
  CONFIRMED
  DECLINED
  COMPLETED
}

// ============================================
// CONTACT MESSAGES
// ============================================

model ContactMessage {
  id        String   @id @default(cuid())
  name      String
  email     String
  phone     String?
  subject   String
  message   String   @db.Text
  status    ContactStatus @default(NEW)
  repliedAt DateTime?
  repliedBy String?
  replyNote String?  @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@map("contact_messages")
}

enum ContactStatus {
  NEW
  READ
  REPLIED
  ARCHIVED
}

// ============================================
// BLOG / NEWS
// ============================================

model BlogPost {
  id            String   @id @default(cuid())
  slug          String   @unique
  title         String
  titleEn       String?  // English title for multi-language
  excerpt       String?  @db.Text
  excerptEn     String?  @db.Text
  content       String   @db.Text
  contentEn     String?  @db.Text // English content
  featuredImage String?
  category      BlogCategory
  tags          String?  // Comma-separated tags
  authorName    String?
  isPublished   Boolean  @default(false)
  publishedAt   DateTime?
  viewCount     Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([isPublished, publishedAt(sort: Desc)])
  @@index([category])
  @@index([slug])
  @@map("blog_posts")
}

enum BlogCategory {
  NEWS
  ANNOUNCEMENT
  EVENT_RECAP
  STUDENT_SPOTLIGHT
  TEACHER_SPOTLIGHT
  COMMUNITY
  TNTT
  GENERAL
}

// ============================================
// SITE TRANSLATIONS (Multi-language)
// ============================================

model Translation {
  id        String   @id @default(cuid())
  key       String   @unique // e.g., "nav.home", "hero.title"
  vi        String   @db.Text // Vietnamese
  en        String   @db.Text // English
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([key])
  @@map("translations")
}
